name: Test Installer Scripts

on:
  push:
    paths:
      - 'scripts/install-macos.sh'
      - 'scripts/install-windows.ps1'
      - '.github/workflows/test-installer-scripts.yml'
  pull_request:
    paths:
      - 'scripts/install-macos.sh'
      - 'scripts/install-windows.ps1'
      - '.github/workflows/test-installer-scripts.yml'
  workflow_dispatch:

jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run macOS installer script
        run: |
          # Run the installer script
          sh scripts/install-macos.sh

      - name: Verify uv is installed
        run: |
          command -v uvx || (echo "uvx not found" && exit 1)
          uvx --version

      - name: Verify Claude Desktop config was created
        run: |
          CONFIG_FILE="$HOME/Library/Application Support/Claude/claude_desktop_config.json"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Config file not created"
            exit 1
          fi
          cat "$CONFIG_FILE"
          # Verify it contains Home Assistant config
          grep -q '"Home Assistant"' "$CONFIG_FILE" || (echo "Home Assistant config not found" && exit 1)
          grep -q 'ha-mcp@latest' "$CONFIG_FILE" || (echo "ha-mcp not configured" && exit 1)

      - name: Verify ha-mcp is cached
        run: |
          # uvx should have cached the package - test it runs
          uvx ha-mcp@latest --help | head -5

  test-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Windows installer script
        shell: pwsh
        run: |
          # Run the installer script
          & ./scripts/install-windows.ps1

      - name: Verify uv is installed
        shell: pwsh
        run: |
          $uvx = Get-Command uvx -ErrorAction SilentlyContinue
          if (-not $uvx) {
            Write-Error "uvx not found"
            exit 1
          }
          uvx --version

      - name: Verify Claude Desktop config was created
        shell: pwsh
        run: |
          $ConfigFile = "$env:APPDATA\Claude\claude_desktop_config.json"
          if (-not (Test-Path $ConfigFile)) {
            Write-Error "Config file not created"
            exit 1
          }
          Get-Content $ConfigFile
          # Verify it contains Home Assistant config
          $content = Get-Content $ConfigFile -Raw
          if ($content -notmatch '"Home Assistant"') {
            Write-Error "Home Assistant config not found"
            exit 1
          }
          if ($content -notmatch 'ha-mcp@latest') {
            Write-Error "ha-mcp not configured"
            exit 1
          }

      - name: Verify ha-mcp is cached
        shell: pwsh
        run: |
          # uvx should have cached the package - test it runs
          uvx ha-mcp@latest --help | Select-Object -First 5
